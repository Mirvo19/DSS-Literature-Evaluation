<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if lang == 'ne' %}विजेताहरू - DSS Talk{% else %}Winners - DSS Talk{% endif %}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="/{{ lang }}/dashboard" class="logo">DSS Talk</a>

                    <nav class="nav-menu">
                        <div class="nav-item">
                            <select id="eventSelect" class="form-select">
                                <option value=""          data-i18n="all">All</option>
                                <option value="debate"       data-i18n="debate">Debate</option>
                                <option value="presentation" data-i18n="presentation">Presentation</option>
                                <option value="extempore"    data-i18n="extempore">Extempore</option>
                            </select>
                        </div>

                        <div class="nav-item">
                            <a href="/{{ lang }}/dashboard" class="nav-link" data-i18n="dashboard">Dashboard</a>
                        </div>

                        <div class="nav-item" data-admin-only style="display: none;">
                            <a href="/{{ lang }}/admin/dashboard" class="nav-link" data-i18n="adminPanel">Admin Panel</a>
                        </div>

                        <div class="nav-item">
                            <button id="logoutBtn" class="btn btn-secondary btn-sm" data-i18n="logout">Logout</button>
                        </div>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="content-wrapper">
            <div class="container">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-i18n="recentWinners">Recent Winners</h2>
                    </div>
                    <div id="winnersArea">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Language locked to server-provided side -->
    <script>
        window.APP_LANG = '{{ lang }}';
        localStorage.setItem('language', '{{ lang }}');
    </script>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        let events = [];
        
        async function loadWinners(eventFilter = '') {
            const winnersArea = document.getElementById('winnersArea');
            winnersArea.innerHTML = '<div class="spinner"></div>';
            
            try {
                let url = '/api/winners?limit=100';
                
                if (eventFilter) {
                    const event = events.find(e => e.name.toLowerCase() === eventFilter.toLowerCase());
                    if (event) {
                        url += `&event_id=${event.id}`;
                    }
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to load winners');
                }
                
                const data = await response.json();
                displayWeeks(data.weeks);
                
            } catch (error) {
                console.error('Error loading winners:', error);
                winnersArea.innerHTML = `
                    <div class="alert alert-error">${i18n.t('error')}: ${error.message}</div>
                `;
            }
        }
        
        function displayWeeks(weeks) {
            const winnersArea = document.getElementById('winnersArea');
            
            if (!weeks || weeks.length === 0) {
                winnersArea.innerHTML = `
                    <div class="text-center">
                        <p data-i18n="noData">${i18n.t('noData')}</p>
                    </div>
                `;
                return;
            }
            
            winnersArea.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-i18n="eventName">${i18n.t('eventName')}</th>
                                <th data-i18n="weekNumber">${i18n.t('weekNumber')}</th>
                                <th>Topic</th>
                                <th data-i18n="date">${i18n.t('date')}</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${weeks.map(w => {
                                const eventName = i18n.getLanguage() === 'ne' && w.sessions?.events?.name_nepali
                                    ? w.sessions.events.name_nepali
                                    : w.sessions?.events?.name || '-';
                                
                                const topic = i18n.getLanguage() === 'ne' && w.topic_nepali
                                    ? w.topic_nepali
                                    : w.topic || '-';
                                
                                const weekNum = w.week_number || '-';
                                const date = w.date;
                                
                                return `
                                    <tr>
                                        <td><strong>${eventName}</strong></td>
                                        <td>${i18n.t('week')} ${weekNum}</td>
                                        <td>${topic}</td>
                                        <td>${date ? new Date(date).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <a href="/${window.APP_LANG}/week-rankings/${w.id}" class="btn btn-sm btn-primary">
                                                ${i18n.t('details')}
                                            </a>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function initialize() {
            // Verify authentication
            const authenticated = await requireAuth();
            if (!authenticated) return;
            
            updateUIForAuth();
            
            // Load events first
            try {
                const response = await fetch('/api/events');
                const data = await response.json();
                events = data.events;
            } catch (error) {
                console.error('Failed to load events:', error);
            }
            
            // Load winners
            await loadWinners();
            
            // Event filter handler
            const eventSelect = document.getElementById('eventSelect');
            eventSelect.addEventListener('change', (e) => {
                loadWinners(e.target.value);
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // lock language to server-provided side - no switcher
            i18n.setLanguage(window.APP_LANG);
            i18n.updatePageTexts();

            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', async () => {
                await auth.logout();
                window.location.href = '/';
            });

            await initialize();
        });
    </script>
</body>
</html>